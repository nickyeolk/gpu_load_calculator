<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GPU Capacity Planner</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    input[type="range"] {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background: transparent;
      cursor: grab;
      width: 100%;
      height: 8px;
    }
    input[type="range"]:active {
      cursor: grabbing;
    }

    /* WebKit (Chrome, Safari, Edge) */
    input[type="range"]::-webkit-slider-runnable-track {
      height: 8px;
      border-radius: 4px;
      background: #475569;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #06b6d4;
      margin-top: -6px;
      border: 2px solid #0e7490;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    input[type="range"]:active::-webkit-slider-thumb {
      box-shadow: 0 0 0 4px rgba(6, 182, 212, 0.2);
    }
    input[type="range"].amber-slider::-webkit-slider-thumb {
      background: #f59e0b;
      border-color: #b45309;
    }
    input[type="range"].amber-slider:active::-webkit-slider-thumb {
      box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.2);
    }

    /* Firefox */
    input[type="range"]::-moz-range-track {
      height: 8px;
      border-radius: 4px;
      background: #475569;
    }
    input[type="range"]::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #06b6d4;
      border: 2px solid #0e7490;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    input[type="range"]:active::-moz-range-thumb {
      box-shadow: 0 0 0 4px rgba(6, 182, 212, 0.2);
    }
    input[type="range"].amber-slider::-moz-range-thumb {
      background: #f59e0b;
      border-color: #b45309;
    }
    input[type="range"].amber-slider:active::-moz-range-thumb {
      box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.2);
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useMemo } = React;

    // Factorial function with memoization for performance
    const factorialCache = {};
    const factorial = (n) => {
      if (n <= 1) return 1;
      if (factorialCache[n]) return factorialCache[n];
      factorialCache[n] = n * factorial(n - 1);
      return factorialCache[n];
    };

    // Erlang-C formula: probability of waiting
    const erlangC = (lambda, mu, servers) => {
      if (servers <= 0) return 1;
      const rho = lambda / (servers * mu);
      if (rho >= 1) return 1; // System unstable
      
      const a = lambda / mu; // Traffic intensity
      
      // Calculate sum for denominator
      let sum = 0;
      for (let k = 0; k < servers; k++) {
        sum += Math.pow(a, k) / factorial(k);
      }
      
      const lastTerm = (Math.pow(a, servers) / factorial(servers)) * (1 / (1 - rho));
      const pWait = lastTerm / (sum + lastTerm);
      
      return pWait;
    };

    // Find minimum servers needed for target wait probability
    const findMinServers = (lambda, mu, targetPWait) => {
      if (lambda <= 0) return 0;
      for (let c = 1; c <= 500; c++) {
        const pWait = erlangC(lambda, mu, c);
        if (pWait <= targetPWait && lambda / (c * mu) < 1) {
          return c;
        }
      }
      return -1;
    };

    // Generate hourly distribution based on work pattern with two peaks
    const generateHourlyDistribution = (workStart, workEnd, peakHour1, peakFactor1, peakHour2, peakFactor2) => {
      const hours = [];
      const workHours = workEnd - workStart;
      const sigma = workHours / 4; // Controls width of each peak
      
      for (let h = 0; h < 24; h++) {
        let factor = 0;
        if (h >= workStart && h < workEnd) {
          // Bell curve around first peak
          const distance1 = Math.abs(h - peakHour1);
          const peak1Contribution = (peakFactor1 - 1) * Math.exp(-Math.pow(distance1, 2) / (2 * sigma * sigma));
          
          // Bell curve around second peak
          const distance2 = Math.abs(h - peakHour2);
          const peak2Contribution = (peakFactor2 - 1) * Math.exp(-Math.pow(distance2, 2) / (2 * sigma * sigma));
          
          // Combine: base of 1 plus the max of both peak contributions (avoids double-counting overlap)
          factor = 1 + Math.max(peak1Contribution, peak2Contribution);
        }
        hours.push({ hour: h, factor });
      }
      // Normalize so average during work hours equals 1
      const workHourFactors = hours.filter((_, i) => i >= workStart && i < workEnd);
      const avgFactor = workHourFactors.reduce((s, h) => s + h.factor, 0) / workHourFactors.length;
      return hours.map(h => ({ ...h, factor: h.factor / avgFactor }));
    };

    function GPUCapacityPlanner() {
      // User inputs
      const [totalUsers, setTotalUsers] = useState(1000);
      const [dauRate, setDauRate] = useState(30);
      const [triggersPerDay, setTriggersPerDay] = useState(5);
      const [gpuDuration, setGpuDuration] = useState(30);
      const [workStart, setWorkStart] = useState(9);
      const [workEnd, setWorkEnd] = useState(18);
      const [peakHour1, setPeakHour1] = useState(10);
      const [peakFactor1, setPeakFactor1] = useState(1.9);
      const [peakHour2, setPeakHour2] = useState(14);
      const [peakFactor2, setPeakFactor2] = useState(1.5);
      const [targetNoWait, setTargetNoWait] = useState(90);
      const [gpuCostPerHour, setGpuCostPerHour] = useState(6.50);
      const [showHourlyDetail, setShowHourlyDetail] = useState(false);
      const [showModelInfo, setShowModelInfo] = useState(false);
      const [hoveredHour, setHoveredHour] = useState(null);
      const [simulateUndersize, setSimulateUndersize] = useState(false);
      const [gpuOverride, setGpuOverride] = useState(1);
      
      // Derived: target probability of waiting
      const targetPWait = 1 - targetNoWait / 100;
      
      const results = useMemo(() => {
        const dailyActiveUsers = totalUsers * (dauRate / 100);
        const workHours = workEnd - workStart;
        const totalDailyRequests = dailyActiveUsers * triggersPerDay;
        const avgRequestsPerWorkHour = totalDailyRequests / workHours;
        
        // Service rate per GPU (requests per hour)
        const mu = 3600 / gpuDuration;
        
        // Generate hourly distribution
        const hourlyDist = generateHourlyDistribution(workStart, workEnd, peakHour1, peakFactor1, peakHour2, peakFactor2);
        
        // Find peak hour lambda
        const maxFactor = Math.max(...hourlyDist.map(h => h.factor));
        const peakLambda = avgRequestsPerWorkHour * maxFactor;
        
        // Find minimum GPUs needed for peak
        const minGPUs = findMinServers(peakLambda, mu, targetPWait);
        
        // Use override if simulation mode is enabled
        const effectiveGPUs = simulateUndersize ? gpuOverride : minGPUs;
        
        // Calculate metrics for each hour
        const hourlyMetrics = hourlyDist.map(h => {
          const lambda = avgRequestsPerWorkHour * h.factor;
          const pWait = h.factor > 0 && effectiveGPUs > 0 ? erlangC(lambda, mu, effectiveGPUs) : 0;
          const utilization = h.factor > 0 && effectiveGPUs > 0 ? lambda / (effectiveGPUs * mu) : 0;
          const exceedsSLA = pWait > targetPWait;
          return {
            hour: h.hour,
            lambda,
            pWait: Math.min(pWait, 1),
            utilization: Math.min(utilization, 1),
            factor: h.factor,
            exceedsSLA
          };
        });
        
        // Cost calculations - Fixed capacity (using effective GPUs for display)
        const dailyGPUHours = effectiveGPUs * 24;
        const dailyCost = dailyGPUHours * gpuCostPerHour;
        const outputsPerDay = dailyActiveUsers;
        const costPerOutput = outputsPerDay > 0 ? dailyCost / outputsPerDay : 0;
        const costPerTrigger = totalDailyRequests > 0 ? dailyCost / totalDailyRequests : 0;
        
        // Alternative: scale GPUs by hour
        const scaledGPUsByHour = hourlyDist.map(h => {
          if (h.factor === 0) return 0;
          const lambda = avgRequestsPerWorkHour * h.factor;
          const optimalGPUs = findMinServers(lambda, mu, targetPWait);
          // Cap at gpuOverride if simulating undersize
          return simulateUndersize ? Math.min(optimalGPUs, gpuOverride) : optimalGPUs;
        });
        const scaledDailyGPUHours = scaledGPUsByHour.reduce((s, g) => s + g, 0);
        const scaledDailyCost = scaledDailyGPUHours * gpuCostPerHour;
        const scaledCostPerOutput = outputsPerDay > 0 ? scaledDailyCost / outputsPerDay : 0;
        const scaledCostPerTrigger = totalDailyRequests > 0 ? scaledDailyCost / totalDailyRequests : 0;

        // Calculate SLA violations for autoscaling when capped
        const scaledHourlyMetrics = hourlyDist.map((h, idx) => {
          const lambda = avgRequestsPerWorkHour * h.factor;
          const gpusForHour = scaledGPUsByHour[idx];
          const pWait = h.factor > 0 && gpusForHour > 0 ? erlangC(lambda, mu, gpusForHour) : 0;
          const exceedsSLA = pWait > targetPWait;
          return { hour: h.hour, pWait: Math.min(pWait, 1), exceedsSLA };
        });
        
        return {
          dailyActiveUsers,
          workHours,
          totalDailyRequests,
          avgRequestsPerWorkHour,
          mu,
          peakLambda,
          minGPUs,
          effectiveGPUs,
          hourlyMetrics,
          dailyCost,
          costPerOutput,
          costPerTrigger,
          scaledGPUsByHour,
          scaledDailyCost,
          scaledCostPerOutput,
          scaledCostPerTrigger,
          scaledHourlyMetrics
        };
      }, [totalUsers, dauRate, triggersPerDay, gpuDuration, workStart, workEnd, peakHour1, peakFactor1, peakHour2, peakFactor2, targetPWait, gpuCostPerHour, simulateUndersize, gpuOverride]);

      const InputField = ({ label, value, onChange, min, max, step = 1, unit = '', highlight = false }) => (
        <div className="mb-3">
          <label className={`block text-sm font-medium mb-1 ${highlight ? 'text-amber-300' : 'text-slate-300'}`}>
            {label}
          </label>
          <div className="flex items-center gap-2">
            <input
              type="range"
              min={min}
              max={max}
              step={step}
              value={value}
              onChange={(e) => onChange(Number(e.target.value))}
              className={`flex-1 h-2 rounded-lg cursor-pointer ${highlight ? 'bg-amber-900 amber-slider' : 'bg-slate-700'}`}
            />
            <span className={`w-20 text-right font-mono text-sm ${highlight ? 'text-amber-300' : 'text-slate-200'}`}>
              {value}{unit}
            </span>
          </div>
        </div>
      );

      const maxBarHeight = 120;
      const maxLambda = Math.max(...results.hourlyMetrics.map(h => h.lambda), 1);

      return (
        <div className="min-h-screen bg-slate-900 text-slate-100 p-6">
          <div className="max-w-6xl mx-auto">
            <h1 className="text-2xl font-bold text-cyan-400 mb-2">GPU Scaling Planner</h1>
            <p className="text-slate-400 mb-2">Queueing theory model for GenAI workloads</p>
            
            {/* Model Info Dropdown */}
            <div className="mb-6">
              <button 
                onClick={() => setShowModelInfo(!showModelInfo)}
                className="text-sm text-slate-500 hover:text-slate-300 flex items-center gap-1 transition-colors"
              >
                <span>{showModelInfo ? '‚ñº' : '‚ñ∂'}</span>
                <span>Statistical Model & Assumptions</span>
              </button>
              {showModelInfo && (
                <div className="mt-2 p-3 bg-slate-800/50 rounded-lg text-sm text-slate-400 border border-slate-700">
                  <p>
                    Uses the <strong className="text-cyan-400">Erlang-C (M/M/c)</strong> queueing model: arrivals follow a <strong>Poisson process</strong> with rate Œª (requests/hr), 
                    service times are <strong>exponentially distributed</strong> with rate Œº = 3600/processing_time. 
                    The formula <em>P(wait) = [A<sup>c</sup>/c! ¬∑ 1/(1-œÅ)] / [Œ£(A<sup>k</sup>/k!) + A<sup>c</sup>/c! ¬∑ 1/(1-œÅ)]</em> calculates 
                    the probability a request must queue, where A = Œª/Œº and œÅ = Œª/(c¬∑Œº). 
                    Hourly demand follows a <strong>Gaussian distribution</strong> around peak hours, normalized so average = 1.
                  </p>
                </div>
              )}
            </div>
            
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              {/* Input Panel */}
              <div className="bg-slate-800 rounded-xl p-5 shadow-lg">
                <h2 className="text-lg font-semibold text-cyan-300 mb-4">üìä Parameters</h2>
                
                <div className="space-y-1">
                  <h3 className="text-sm font-medium text-slate-400 uppercase tracking-wide mt-4 mb-2">User Base</h3>
                  <InputField label="Total Registered Users" value={totalUsers} onChange={setTotalUsers} min={100} max={10000} step={100} />
                  <InputField 
                  label="Daily Active User Rate" 
                  value={dauRate} 
                  onChange={setDauRate} 
                  min={5} 
                  max={100} 
                  unit="%" 
                  highlight={false}
                  />
                  
                  {/* DAU callout */}
                  <div className="bg-cyan-900/30 border border-cyan-700/50 rounded-lg p-3 mb-3">
                    <div className="text-cyan-300 text-sm font-medium">
                      Active Users Today: {Math.round(results.dailyActiveUsers).toLocaleString()}
                      </div>
                      <div className="text-cyan-200/70 text-xs mt-1">
                        = {totalUsers.toLocaleString()} √ó {dauRate}%
                        </div>
                        </div>
                        
                        <InputField label="GPU Triggers per Active User" value={triggersPerDay} onChange={setTriggersPerDay} min={1} max={50} />
                        <InputField label="GPU Processing Time per Trigger" value={gpuDuration} onChange={setGpuDuration} min={5} max={120} unit="s" />
                        
                  <h3 className="text-sm font-medium text-slate-400 uppercase tracking-wide mt-6 mb-2">Work Pattern</h3>
                  <InputField label="Work Start Hour" value={workStart} onChange={setWorkStart} min={0} max={23} unit="h" />
                  <InputField label="Work End Hour" value={workEnd} onChange={setWorkEnd} min={1} max={24} unit="h" />
                  
                  <h4 className="text-xs font-medium text-cyan-400 uppercase tracking-wide mt-4 mb-1">Peak 1 (Morning)</h4>
                  <InputField label="Peak Hour 1" value={peakHour1} onChange={setPeakHour1} min={workStart} max={workEnd - 1} unit="h" />
                  <InputField label="Peak Factor 1" value={peakFactor1} onChange={setPeakFactor1} min={1} max={4} step={0.1} unit="√ó" />
                  
                  <h4 className="text-xs font-medium text-cyan-400 uppercase tracking-wide mt-4 mb-1">Peak 2 (Afternoon)</h4>
                  <InputField label="Peak Hour 2" value={peakHour2} onChange={setPeakHour2} min={workStart} max={workEnd - 1} unit="h" />
                  <InputField label="Peak Factor 2" value={peakFactor2} onChange={setPeakFactor2} min={1} max={4} step={0.1} unit="√ó" />
                  
                  <h3 className="text-sm font-medium text-slate-400 uppercase tracking-wide mt-6 mb-2">SLA & Cost</h3>
                  <InputField 
                  label="Target % Not Waiting (SLA)" 
                  value={targetNoWait} 
                  onChange={setTargetNoWait} 
                  min={1} 
                  max={99} 
                  unit="%" 
                  highlight={false}
                  />
                  
                  {/* SLA Explanation */}
                  <div className="bg-cyan-900/30 border border-cyan-700/50 rounded-lg p-3 mb-3">
                    <div className="text-cyan-300 text-sm font-medium">
                      SLA: {targetNoWait}% immediate service
                      </div>
                      <div className="text-cyan-200/70 text-xs mt-1">
                        ‚â§{(100 - targetNoWait)}% of users may wait in queue
                        </div>
                    <div className="text-cyan-200/70 text-xs">
                      P(wait) threshold: {(targetPWait * 100).toFixed(1)}%
                      </div>
                  </div>
                  
                  <InputField label="GPU Cost per Hour" value={gpuCostPerHour} onChange={setGpuCostPerHour} min={0.5} max={10} step={0.1} unit="$" />
                  </div>
              </div>

              {/* Results Panel */}
              <div className="lg:col-span-2 space-y-6">
                {/* Key Metrics */}
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                  <div className={`rounded-xl p-4 text-center ${simulateUndersize ? 'bg-red-900/30 border border-red-700/50' : 'bg-slate-800'}`}>
                    <div className={`text-3xl font-bold ${simulateUndersize ? 'text-red-400' : 'text-cyan-400'}`}>
                      {simulateUndersize ? gpuOverride : results.minGPUs}
                    </div>
                    <div className="text-sm text-slate-400">
                      {simulateUndersize ? 'Simulated GPUs' : 'GPUs Needed at Peak'}
                    </div>
                    {simulateUndersize && (
                      <div className="text-xs text-slate-500 mt-1">(need {results.minGPUs})</div>
                    )}
                  </div>
                    <div className="bg-slate-800 rounded-xl p-4 text-center">
                      <div className="text-3xl font-bold text-amber-400">{results.peakLambda.toFixed(0)}</div>
                      <div className="text-sm text-slate-400">Peak Requests/hr</div>
                      </div>
                      <div className="bg-slate-800 rounded-xl p-4 text-center">
                        <div className="text-3xl font-bold text-purple-400">{results.totalDailyRequests.toLocaleString()}</div>
                        <div className="text-sm text-slate-400">Daily Triggers</div>
                        </div>
                        <div className="bg-slate-800 rounded-xl p-4 text-center">
                    <div className="text-3xl font-bold text-emerald-400">{Math.round(results.dailyActiveUsers).toLocaleString()}</div>
                    <div className="text-sm text-slate-400">Daily Outputs</div>
                    </div>
                </div>
                
                {/* Simulation Toggle */}
                <div className={`rounded-xl p-4 ${simulateUndersize ? 'bg-red-900/20 border border-red-700/50' : 'bg-slate-800'}`}>
                  <div className="flex items-center justify-between flex-wrap gap-4">
                    <div className="flex items-center gap-3">
                      <button
                        onClick={() => {
                          if (!simulateUndersize) setGpuOverride(Math.max(1, results.minGPUs - 1));
                          setSimulateUndersize(!simulateUndersize);
                        }}
                        className={`px-4 py-2 rounded-lg font-medium text-sm transition-colors ${
                          simulateUndersize 
                            ? 'bg-red-600 text-white hover:bg-red-700' 
                            : 'bg-slate-700 text-slate-300 hover:bg-slate-600'
                        }`}
                      >
                        {simulateUndersize ? 'üî¥ Simulating Undersize' : 'üß™ Simulate Undersize'}
                      </button>
                      <span className="text-sm text-slate-400">
                        {simulateUndersize ? 'See what happens with fewer GPUs' : 'Test SLA impact with reduced capacity'}
                      </span>
                    </div>
                    {simulateUndersize && (
                      <div className="flex items-center gap-3">
                        <label className="text-sm text-slate-300">Force GPUs:</label>
                        <input
                          type="range"
                          min={1}
                          max={Math.max(results.minGPUs, 10)}
                          value={gpuOverride}
                          onChange={(e) => setGpuOverride(Number(e.target.value))}
                          className="w-32 h-2 rounded-lg cursor-pointer bg-red-900"
                        />
                        <span className="text-red-400 font-mono font-bold w-8">{gpuOverride}</span>
                      </div>
                    )}
                  </div>
                  {simulateUndersize && results.hourlyMetrics.some(h => h.exceedsSLA) && (
                    <div className="mt-3 p-2 bg-red-900/30 rounded-lg text-sm text-red-300">
                      ‚ö†Ô∏è SLA exceeded during {results.hourlyMetrics.filter(h => h.exceedsSLA).length} hour(s)! 
                      Peak P(wait) = {(Math.max(...results.hourlyMetrics.map(h => h.pWait)) * 100).toFixed(1)}% 
                      (target ‚â§ {(targetPWait * 100).toFixed(1)}%)
                    </div>
                  )}
                </div>
                    
                    {/* Hourly Chart */}
                    <div className="bg-slate-800 rounded-xl p-5 shadow-lg">
                      <h2 className="text-lg font-semibold text-cyan-300 mb-2">üìà Hourly Load Distribution</h2>
                      <p className="text-sm text-slate-400 mb-4">
                        {simulateUndersize 
                          ? `Showing impact of ${gpuOverride} GPUs (need ${results.minGPUs} for SLA). Red bars exceed SLA.`
                          : `Sized for peak hour. Bars show P(wait) at each hour vs your ${targetNoWait}% SLA target.`
                        }
                      </p>
                      
                      {/* Hover info */}
                      <div className="h-16 mb-2">
                        {hoveredHour !== null && results.hourlyMetrics[hoveredHour] && (
                          <div className="bg-slate-700 rounded-lg p-3 text-sm">
                            <div className="flex flex-wrap justify-between items-center gap-4">
                              <div>
                                <span className="text-slate-400">Hour:</span>
                                <span className="text-white font-bold ml-2">{hoveredHour}:00</span>
                              </div>
                              <div>
                                <span className="text-slate-400">Requests/hr:</span>
                                <span className="text-cyan-400 font-bold ml-2">{results.hourlyMetrics[hoveredHour].lambda.toFixed(0)}</span>
                              </div>
                              <div>
                                <span className="text-slate-400">P(wait):</span>
                                <span className={`font-bold ml-2 ${results.hourlyMetrics[hoveredHour].exceedsSLA ? 'text-red-400' : 'text-emerald-400'}`}>
                                  {(results.hourlyMetrics[hoveredHour].pWait * 100).toFixed(2)}%
                                </span>
                              </div>
                              <div>
                                <span className="text-slate-400">Utilization:</span>
                                <span className="text-amber-400 font-bold ml-2">{(results.hourlyMetrics[hoveredHour].utilization * 100).toFixed(1)}%</span>
                              </div>
                              <div>
                                <span className={`px-2 py-1 rounded text-xs font-medium ${results.hourlyMetrics[hoveredHour].exceedsSLA ? 'bg-red-900 text-red-300' : 'bg-emerald-900 text-emerald-300'}`}>
                                  {results.hourlyMetrics[hoveredHour].exceedsSLA ? 'EXCEEDS SLA' : 'WITHIN SLA'}
                                </span>
                              </div>
                            </div>
                          </div>
                        )}
                        {hoveredHour === null && (
                          <div className="text-slate-500 text-sm italic pt-2">Hover over bars to see hourly details</div>
                        )}
                      </div>
                      
                      <div className="flex items-end justify-between gap-1 h-40">
                        {results.hourlyMetrics.map((h, i) => (
                          <div 
                            key={i} 
                            className="flex flex-col items-center flex-1 cursor-pointer"
                            onMouseEnter={() => setHoveredHour(i)}
                            onMouseLeave={() => setHoveredHour(null)}
                          >
                            <div 
                              className="w-full rounded-t transition-all duration-300 hover:opacity-80"
                              style={{
                                height: `${(h.lambda / maxLambda) * maxBarHeight}px`,
                                backgroundColor: h.lambda === 0 ? '#334155' : h.exceedsSLA ? '#ef4444' : '#06b6d4'
                              }}
                            />
                            <span className="text-xs text-slate-500 mt-1">{h.hour}</span>
                          </div>
                        ))}
                      </div>
                      
                      {/* Legend with SLA threshold */}
                      <div className="flex justify-center items-center gap-6 mt-4 text-sm">
                        <span className="flex items-center gap-2">
                          <span className="w-3 h-3 rounded bg-cyan-500"></span>
                          <span className="text-slate-400">Within SLA (P(wait) ‚â§ {(targetPWait * 100).toFixed(0)}%)</span>
                        </span>
                        <span className="flex items-center gap-2">
                          <span className="w-3 h-3 rounded bg-red-500"></span>
                          <span className="text-slate-400">Exceeds SLA (P(wait) &gt; {(targetPWait * 100).toFixed(0)}%)</span>
                        </span>
                      </div>
                      
                      {/* Explanation box */}
                      <div className="mt-4 p-3 bg-slate-700/50 rounded-lg text-sm">
                        <p className="text-slate-300">
                          <strong className="text-cyan-400">How it works:</strong> GPUs are sized to meet your SLA at the <strong>highest peak</strong> (peaks at {peakHour1}:00 and {peakHour2}:00). 
                          Since capacity is fixed, off-peak hours will have lower P(wait) and appear cyan. 
                          All bars should be cyan unless the system is undersized.
                        </p>
                      </div>
                    </div>
                    {/* Cost Metrics */}
                    <div className="bg-gradient-to-r from-emerald-900/40 to-cyan-900/40 rounded-xl p-5 border border-emerald-700/30">
                      <h2 className="text-lg font-semibold text-emerald-300 mb-4">üí∞ Cost Metrics</h2>
                      
                      {/* Fixed Capacity */}
                      <h3 className="text-md font-medium text-slate-300 mb-3">Fixed Capacity (24/7)</h3>
                      <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div className="bg-slate-800/50 rounded-lg p-4 text-center">
                          <div className="text-2xl font-bold text-emerald-400">${results.costPerOutput.toFixed(2)}</div>
                          <div className="text-sm text-slate-400">Per Output</div>
                          <div className="text-xs text-slate-500 mt-1">({triggersPerDay} triggers)</div>
                        </div>
                        <div className="bg-slate-800/50 rounded-lg p-4 text-center">
                          <div className="text-2xl font-bold text-cyan-400">${results.costPerTrigger.toFixed(3)}</div>
                          <div className="text-sm text-slate-400">Per Trigger</div>
                          <div className="text-xs text-slate-500 mt-1">(single GPU call)</div>
                        </div>
                        <div className="bg-slate-800/50 rounded-lg p-4 text-center">
                          <div className="text-2xl font-bold text-amber-400">${results.dailyCost.toFixed(0)}</div>
                          <div className="text-sm text-slate-400">Daily Cost</div>
                          <div className="text-xs text-slate-500 mt-1">({results.effectiveGPUs} √ó 24 √ó ${gpuCostPerHour})</div>
                        </div>
                        <div className="bg-slate-800/50 rounded-lg p-4 text-center">
                          <div className="text-2xl font-bold text-purple-400">${(results.dailyCost * 30).toFixed(0)}</div>
                          <div className="text-sm text-slate-400">Monthly Cost</div>
                          <div className="text-xs text-slate-500 mt-1">(30 days)</div>
                        </div>
                      </div>
                      
                      {/* Auto-Scaling */}
                      <h3 className="text-md font-medium text-slate-300 mb-3">Auto-Scaling (Scale by Hour)</h3>
                      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div className="bg-slate-800/50 rounded-lg p-4 text-center">
                          <div className="text-2xl font-bold text-emerald-400">${results.scaledCostPerOutput.toFixed(2)}</div>
                          <div className="text-sm text-slate-400">Per Output</div>
                          <div className="text-xs text-slate-500 mt-1">({triggersPerDay} triggers)</div>
                        </div>
                        <div className="bg-slate-800/50 rounded-lg p-4 text-center">
                          <div className="text-2xl font-bold text-cyan-400">${results.scaledCostPerTrigger.toFixed(3)}</div>
                          <div className="text-sm text-slate-400">Per Trigger</div>
                          <div className="text-xs text-slate-500 mt-1">(single GPU call)</div>
                        </div>
                        <div className="bg-slate-800/50 rounded-lg p-4 text-center">
                          <div className="text-2xl font-bold text-amber-400">${results.scaledDailyCost.toFixed(0)}</div>
                          <div className="text-sm text-slate-400">Daily Cost</div>
                          <div className="text-xs text-slate-500 mt-1">({results.scaledGPUsByHour.reduce((s, g) => s + g, 0)} GPU-hrs)</div>
                        </div>
                        <div className="bg-slate-800/50 rounded-lg p-4 text-center">
                          <div className="text-2xl font-bold text-purple-400">${(results.scaledDailyCost * 30).toFixed(0)}</div>
                          <div className="text-sm text-slate-400">Monthly Cost</div>
                          <div className="text-xs text-slate-500 mt-1">(30 days)</div>
                        </div>
                      </div>
                      
                      {/* Savings callout */}
                      {results.dailyCost > 0 && (
                        <div className="mt-4 space-y-2">
                          <div className="p-3 bg-emerald-900/30 rounded-lg border border-emerald-700/50">
                            <span className="text-emerald-400 font-medium">
                              üí° Auto-scaling saves ${(results.dailyCost - results.scaledDailyCost).toFixed(2)}/day
                              ({((1 - results.scaledDailyCost / results.dailyCost) * 100).toFixed(0)}% reduction)
                              ‚Äî ${((results.dailyCost - results.scaledDailyCost) * 30).toFixed(0)}/month
                            </span>
                          </div>
                          {simulateUndersize && results.scaledHourlyMetrics.some(h => h.exceedsSLA) && (
                            <div className="p-3 bg-red-900/30 rounded-lg border border-red-700/50">
                              <span className="text-red-300 font-medium">
                                ‚ö†Ô∏è Capped auto-scaling violates SLA during {results.scaledHourlyMetrics.filter(h => h.exceedsSLA).length} hour(s)!
                                Peak P(wait) = {(Math.max(...results.scaledHourlyMetrics.map(h => h.pWait)) * 100).toFixed(1)}%
                                (target ‚â§ {(targetPWait * 100).toFixed(1)}%)
                              </span>
                            </div>
                          )}
                        </div>
                      )}
                    </div>
                            
                            {/* Request breakdown */}
                            <div className="bg-slate-800 rounded-xl p-5 shadow-lg">
                  <h2 className="text-lg font-semibold text-cyan-300 mb-3">üßÆ Request Calculation Breakdown</h2>
                  <div className="bg-slate-700/50 rounded-lg p-4 font-mono text-sm space-y-2">
                    <div className="flex justify-between items-center">
                      <span className="text-slate-400">Total Registered Users:</span>
                      <span className="text-slate-200">{totalUsers.toLocaleString()}</span>
                    </div>
                    <div className="flex justify-between items-center">
                      <span className="text-slate-400">√ó DAU Rate:</span>
                      <span className="text-amber-400">{dauRate}%</span>
                    </div>
                    <div className="flex justify-between items-center border-t border-slate-600 pt-2">
                      <span className="text-slate-300">= Daily Active Users (Outputs):</span>
                      <span className="text-cyan-400 font-bold">{Math.round(results.dailyActiveUsers).toLocaleString()}</span>
                    </div>
                    <div className="flex justify-between items-center">
                      <span className="text-slate-400">√ó Triggers per User:</span>
                      <span className="text-slate-200">{triggersPerDay}</span>
                    </div>
                    <div className="flex justify-between items-center border-t border-slate-600 pt-2">
                      <span className="text-slate-300">= Total Daily Triggers:</span>
                      <span className="text-emerald-400 font-bold">{results.totalDailyRequests.toLocaleString()}</span>
                    </div>
                  </div>
                </div>

                {/* Cost Comparison - Fixed vs Auto-scaling */}
                <div className="bg-slate-800 rounded-xl p-5 shadow-lg">
                  <h2 className="text-lg font-semibold text-cyan-300 mb-4">‚öñÔ∏è Fixed vs Auto-Scaling Comparison</h2>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div className="bg-slate-700/50 rounded-lg p-4">
                      <h3 className="font-medium text-slate-300 mb-3">Fixed Capacity (24/7)</h3>
                      <div className="space-y-2 text-sm">
                        <div className="flex justify-between">
                          <span className="text-slate-400">GPUs Always On:</span>
                          <span className="text-slate-200">{results.minGPUs}</span>
                        </div>
                        <div className="flex justify-between">
                          <span className="text-slate-400">Daily GPU-Hours:</span>
                          <span className="text-slate-200">{results.minGPUs * 24}</span>
                        </div>
                        <div className="flex justify-between">
                          <span className="text-slate-400">Daily Cost:</span>
                          <span className="text-slate-200">${results.dailyCost.toFixed(2)}</span>
                        </div>
                        <div className="flex justify-between border-t border-slate-600 pt-2 mt-2">
                          <span className="text-slate-300">Cost per Output:</span>
                          <span className="text-emerald-400 font-bold">${results.costPerOutput.toFixed(2)}</span>
                        </div>
                        <div className="flex justify-between">
                          <span className="text-slate-300">Cost per Trigger:</span>
                          <span className="text-cyan-400 font-bold">${results.costPerTrigger.toFixed(3)}</span>
                        </div>
                      </div>
                    </div>
                    <div className={`rounded-lg p-4 ${simulateUndersize && results.scaledHourlyMetrics.some(h => h.exceedsSLA) ? 'bg-red-900/20 border border-red-700/50' : 'bg-slate-700/50'}`}>
                      <h3 className="font-medium text-slate-300 mb-3">
                        Auto-Scaling {simulateUndersize && '(Capped)'}
                      </h3>
                      <div className="space-y-2 text-sm">
                        <div className="flex justify-between">
                          <span className="text-slate-400">Max GPUs (peak):</span>
                          <span className={simulateUndersize ? 'text-red-400' : 'text-slate-200'}>
                            {Math.max(...results.scaledGPUsByHour)}
                            {simulateUndersize && ` (capped at ${gpuOverride})`}
                          </span>
                        </div>
                        <div className="flex justify-between">
                          <span className="text-slate-400">Daily GPU-Hours:</span>
                          <span className="text-slate-200">{results.scaledGPUsByHour.reduce((s, g) => s + g, 0)}</span>
                        </div>
                        <div className="flex justify-between">
                          <span className="text-slate-400">Daily Cost:</span>
                          <span className="text-slate-200">${results.scaledDailyCost.toFixed(2)}</span>
                        </div>
                        <div className="flex justify-between border-t border-slate-600 pt-2 mt-2">
                          <span className="text-slate-300">Cost per Output:</span>
                          <span className="text-emerald-400 font-bold">${results.scaledCostPerOutput.toFixed(2)}</span>
                        </div>
                        <div className="flex justify-between">
                          <span className="text-slate-300">Cost per Trigger:</span>
                          <span className="text-cyan-400 font-bold">${results.scaledCostPerTrigger.toFixed(3)}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                  {results.dailyCost > 0 && (
                    <div className="mt-4 space-y-2">
                      <div className="p-3 bg-emerald-900/30 rounded-lg border border-emerald-700/50">
                        <span className="text-emerald-400 font-medium">
                          üí° Auto-scaling saves ${(results.dailyCost - results.scaledDailyCost).toFixed(2)}/day
                          ({((1 - results.scaledDailyCost / results.dailyCost) * 100).toFixed(0)}% reduction)
                          ‚Äî ${((results.dailyCost - results.scaledDailyCost) * 30).toFixed(0)}/month
                        </span>
                      </div>
                      {simulateUndersize && results.scaledHourlyMetrics.some(h => h.exceedsSLA) && (
                        <div className="p-3 bg-red-900/30 rounded-lg border border-red-700/50">
                          <span className="text-red-300 font-medium">
                            ‚ö†Ô∏è Capped auto-scaling violates SLA during {results.scaledHourlyMetrics.filter(h => h.exceedsSLA).length} hour(s)!
                            Peak P(wait) = {(Math.max(...results.scaledHourlyMetrics.map(h => h.pWait)) * 100).toFixed(1)}%
                            (target ‚â§ {(targetPWait * 100).toFixed(1)}%)
                          </span>
                        </div>
                      )}
                    </div>
                  )}
                </div>

                {/* DAU benchmarks */}
                <div className="bg-slate-800 rounded-xl p-5 shadow-lg">
                  <h2 className="text-lg font-semibold text-cyan-300 mb-3">üìä Typical DAU Rates by Product Type</h2>
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                    <div className="bg-slate-700/50 rounded-lg p-3 text-center">
                      <div className="text-2xl font-bold text-red-400">5-15%</div>
                      <div className="text-slate-400">Monthly tools</div>
                      <div className="text-xs text-slate-500">Tax, invoicing</div>
                    </div>
                    <div className="bg-slate-700/50 rounded-lg p-3 text-center">
                      <div className="text-2xl font-bold text-amber-400">15-30%</div>
                      <div className="text-slate-400">Weekly tools</div>
                      <div className="text-xs text-slate-500">Analytics, reports</div>
                    </div>
                    <div className="bg-slate-700/50 rounded-lg p-3 text-center">
                      <div className="text-2xl font-bold text-emerald-400">30-50%</div>
                      <div className="text-slate-400">Daily workflow</div>
                      <div className="text-xs text-slate-500">Image editing, design</div>
                    </div>
                    <div className="bg-slate-700/50 rounded-lg p-3 text-center">
                      <div className="text-2xl font-bold text-cyan-400">50-80%</div>
                      <div className="text-slate-400">Core work tool</div>
                      <div className="text-xs text-slate-500">Slack, IDE, email</div>
                    </div>
                  </div>
                </div>

                {/* P(wait) by hour detail table - collapsible */}
                <div className="bg-slate-800 rounded-xl shadow-lg overflow-hidden">
                  <button 
                    onClick={() => setShowHourlyDetail(!showHourlyDetail)}
                    className="w-full p-4 flex items-center justify-between text-left hover:bg-slate-700/50 transition-colors"
                  >
                    <h2 className="text-lg font-semibold text-cyan-300">üìã Hourly P(wait) Detail</h2>
                    <span className="text-slate-400 text-sm flex items-center gap-2">
                      {showHourlyDetail ? 'Hide' : 'Show'}
                      <svg 
                        className={`w-5 h-5 transition-transform ${showHourlyDetail ? 'rotate-180' : ''}`} 
                        fill="none" 
                        stroke="currentColor" 
                        viewBox="0 0 24 24"
                      >
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                      </svg>
                    </span>
                  </button>
                  {showHourlyDetail && (
                    <div className="px-5 pb-5">
                      <div className="overflow-x-auto">
                        <table className="w-full text-sm">
                          <thead>
                            <tr className="text-slate-400 border-b border-slate-700">
                              <th className="text-left py-2 px-2">Hour</th>
                              <th className="text-right py-2 px-2">Requests/hr</th>
                              <th className="text-right py-2 px-2">P(wait)</th>
                              <th className="text-right py-2 px-2">% Served Immediately</th>
                              <th className="text-right py-2 px-2">Utilization</th>
                              <th className="text-center py-2 px-2">Status</th>
                            </tr>
                          </thead>
                          <tbody>
                            {results.hourlyMetrics.filter(h => h.lambda > 0).map((h, i) => (
                              <tr key={i} className="border-b border-slate-700/50 hover:bg-slate-700/30">
                                <td className="py-2 px-2 font-mono">{h.hour}:00</td>
                                <td className="py-2 px-2 text-right font-mono text-cyan-400">{h.lambda.toFixed(0)}</td>
                                <td className="py-2 px-2 text-right font-mono">
                                  <span className={h.exceedsSLA ? 'text-red-400' : 'text-emerald-400'}>
                                    {(h.pWait * 100).toFixed(2)}%
                                  </span>
                                </td>
                                <td className="py-2 px-2 text-right font-mono text-slate-300">
                                  {((1 - h.pWait) * 100).toFixed(2)}%
                                </td>
                                <td className="py-2 px-2 text-right font-mono text-amber-400">
                                  {(h.utilization * 100).toFixed(1)}%
                                </td>
                                <td className="py-2 px-2 text-center">
                                  <span className={`px-2 py-0.5 rounded text-xs ${h.exceedsSLA ? 'bg-red-900/50 text-red-300' : 'bg-emerald-900/50 text-emerald-300'}`}>
                                    {h.exceedsSLA ? '‚úó FAIL' : '‚úì PASS'}
                                  </span>
                                </td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                      <div className="mt-3 text-xs text-slate-500">
                        SLA Target: {targetNoWait}% served immediately ‚Üí P(wait) must be ‚â§ {(targetPWait * 100).toFixed(1)}%
                      </div>
                    </div>
                  )}
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<GPUCapacityPlanner />);
  </script>
</body>
</html>
